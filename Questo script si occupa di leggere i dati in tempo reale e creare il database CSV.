import serial
import csv
from datetime import datetime

# NOTA: Cambia 'COM3' con la tua porta (es. '/dev/ttyACM0' su Linux/Mac)
port = 'COM3' 
baud = 9600
file_name = "log_led.csv"

try:
    ser = serial.Serial(port, baud, timeout=1)
    print(f"Connesso a {port}. Premi il pulsante su Arduino...")
    
    with open(file_name, mode='a', newline='') as file:
        writer = csv.writer(file)
        # Scrive intestazione solo se il file Ã¨ vuoto
        if file.tell() == 0:
            writer.writerow(["timestamp", "evento", "led_fase"])
        
        while True:
            if ser.in_waiting > 0:
                line = ser.readline().decode('utf-8').strip()
                if "," in line:
                    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    id_ev, led_n = line.split(",")
                    writer.writerow([timestamp, id_ev, f"LED {led_n}"])
                    file.flush()
                    print(f"Salvato: {timestamp} | Evento: {id_ev} | {led_n}")
except KeyboardInterrupt:
    print("\nChiusura programma.")
except Exception as e:
    print(f"Errore: {e}")
